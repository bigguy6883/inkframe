{% extends "base.html" %}

{% block title %}Connect Google Photos - photos.local{% endblock %}

{% block content %}
<div class="setup-wizard">
    <div class="step-indicator">
        <span class="step complete">1. WiFi</span>
        <span class="step active">2. Google</span>
        <span class="step">3. Photos</span>
    </div>

    <h2>Connect Google Photos</h2>

    {% if not rclone_installed %}
    <div class="setup-step">
        <h3>Step 1: Install rclone</h3>
        <p>SSH into this device and run:</p>
        <pre>sudo apt install rclone</pre>
        <button class="btn btn-secondary" onclick="checkStatus()">I've installed it</button>
    </div>

    {% elif not gphotos_remote %}
    <div class="setup-step">
        <h3>Step 2: Configure Google Photos</h3>
        <p>SSH into this device and run:</p>
        <pre>rclone config</pre>
        <ol>
            <li>Choose <strong>n</strong> for new remote</li>
            <li>Name it <strong>gphotos</strong></li>
            <li>Choose <strong>google photos</strong> as the type</li>
            <li>Leave client_id and client_secret blank (press Enter)</li>
            <li>Choose <strong>read only</strong> access</li>
            <li>For auto config, choose <strong>n</strong> (no)</li>
            <li>Copy the URL shown, open it in your browser</li>
            <li>Sign in and authorize access</li>
            <li>Paste the verification code back into the terminal</li>
            <li>Confirm with <strong>y</strong></li>
        </ol>
        <button class="btn btn-primary" onclick="checkStatus()">I've configured it</button>
    </div>

    {% else %}
    <div class="setup-step success">
        <h3>Connected!</h3>
        <p>Google Photos remote "<strong>{{ gphotos_remote }}</strong>" is configured.</p>
        <a href="{{ url_for('setup_album') }}" class="btn btn-primary btn-large">Select Album</a>
    </div>
    {% endif %}

    <p id="status" class="status-text"></p>
</div>

<style>
.setup-step {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin: 1rem 0;
}

.setup-step.success {
    background: #e8f5e9;
    border: 1px solid #4caf50;
}

.setup-step h3 {
    margin-top: 0;
}

.setup-step pre {
    background: #263238;
    color: #aed581;
    padding: 1rem;
    border-radius: 4px;
    overflow-x: auto;
}

.setup-step ol {
    line-height: 1.8;
}

.status-text {
    margin-top: 1rem;
    padding: 0.5rem;
    border-radius: 4px;
}

.status-text.checking {
    color: #1976d2;
}

.status-text.success {
    color: #388e3c;
    background: #e8f5e9;
}

.status-text.error {
    color: #d32f2f;
    background: #ffebee;
}
</style>

<script>
function checkStatus() {
    const status = document.getElementById('status');
    status.textContent = 'Checking...';
    status.className = 'status-text checking';

    fetch('/setup/check-rclone')
        .then(r => r.json())
        .then(data => {
            if (data.configured) {
                status.textContent = 'Configured! Redirecting...';
                status.className = 'status-text success';
                setTimeout(() => location.reload(), 1000);
            } else if (data.installed && !data.remote) {
                status.textContent = 'rclone installed but no Google Photos remote found. Run "rclone config" to set it up.';
                status.className = 'status-text';
                setTimeout(() => location.reload(), 1500);
            } else if (!data.installed) {
                status.textContent = 'rclone not found. Please install it first.';
                status.className = 'status-text error';
            } else {
                status.textContent = 'Not configured yet. Please complete the setup.';
                status.className = 'status-text';
            }
        })
        .catch(err => {
            status.textContent = 'Error checking status';
            status.className = 'status-text error';
        });
}
</script>
{% endblock %}
